---
import AdminSidebar from "../components/admin/AdminSidebar";
import "../styles/global.css";

const { title = "SPSMB Admin" } = Astro.props;
---

<!doctype html>
<html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <title>{title}</title>
    </head>
    <body class="bg-slate-50">
        <div class="flex min-h-screen">
            <AdminSidebar client:only="react" />
            <main class="flex-1 p-8 overflow-auto">
                <div
                    id="auth-loading"
                    class="flex items-center justify-center h-full"
                >
                    <div
                        class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"
                    >
                    </div>
                </div>

                <div
                    id="auth-error"
                    class="hidden h-full flex flex-col items-center justify-center text-red-600"
                >
                    <div
                        class="bg-red-50 p-6 rounded-lg border border-red-200 text-center max-w-md"
                    >
                        <h3 class="font-bold text-lg mb-2">
                            Gagal Memuat Halaman
                        </h3>
                        <p class="mb-4 text-sm text-red-700">
                            Terjadi kesalahan saat memeriksa status login.
                        </p>
                        <p
                            id="error-detail"
                            class="text-xs font-mono bg-white p-2 rounded border border-red-100 mb-4 text-left overflow-auto max-h-32"
                        >
                        </p>
                        <a
                            href="/admin/login"
                            class="inline-block bg-white text-red-600 border border-red-600 px-4 py-2 rounded hover:bg-red-50 font-medium"
                            >Kembali ke Login</a
                        >
                    </div>
                </div>

                <div id="admin-content" class="hidden">
                    <slot />
                </div>
            </main>
        </div>

        <script>
            import { supabase } from "../lib/supabase";

            const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
            const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

            if (!supabaseUrl || !supabaseKey) {
                console.error("Supabase URL or Key missing in AdminLayout");
                // We will handle this in checkAuth by checking if supabase is initialized,
                // or just letting checkAuth fail gracefully if we can't init supabase.
            }

            // supabase is now imported from ../lib/supabase

            async function checkAuth() {
                const loader = document.getElementById("auth-loading");
                const content = document.getElementById("admin-content");
                const errorDiv = document.getElementById("auth-error");

                // Simple Auth Check
                const isLoggedIn =
                    localStorage.getItem("admin_logged_in") === "true";
                const isBypass =
                    localStorage.getItem("admin_bypass") === "true";

                if (isLoggedIn || isBypass) {
                    if (loader) loader.classList.add("hidden");
                    if (content) content.classList.remove("hidden");
                    return;
                }

                // If not logged in, redirect to login
                window.location.href = "/admin/login";
            }

            checkAuth();
        </script>
    </body>
</html>
